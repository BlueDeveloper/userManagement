<!DOCTYPE html>
<html lang="ko" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/common/layout/layout.html}">
<head>
    <script>
        $(function () {
            // 아이디/비밀번호 찾기 버튼 클릭
            $(".findIdBtn, .findPwBtn").on("click", function (e) {
                $(".loginTitle").find("span").html(e.target.textContent).css("font-size", "1.2rem")
                $(".loginFrm, .findIdPwDiv, .loginBtnDiv").hide();
                $("." + e.target.className.substring(0, 6) + "Div").removeClass("d-none")
            })


            $(".sendAuthNumberBtn").on("click", function (e) {
                let sendAuthNumBtn = e.target // 버튼 node
                let topParentNode = $(e.target).parent().parent() // 버튼이 속해있는 최상위 노드
                let email = $(topParentNode).find(".fEmail").val() // 이메일
                let id = ""; // ID

                if (email === "" || email === undefined) {       // 이메일 체크
                    alert("이메일을 입력해주세요.");
                    return;
                } else {
                    if (!reg_email.test(email)) {        // 이메일 형식인지 체크
                        alert("이메일 형식이 아닙니다.");
                        return;
                    }
                }

                // 비밀번호 찾기 시 ID추가 전송
                if (sendAuthNumBtn.dataset.type === "1") {
                    id = $(topParentNode).find(".fId").val()
                }

                // 데이터
                let param = {
                    email: email,
                    id: id
                }

                // 인증번호 전송(서버작업해주세용>3<)
                if (sendAuthNumBtn.dataset.type !== "2") {
                    ajaxCall("POST", "/api/view/user/sendAuth", param, null,
                        (data) => {
                            if (data.code === "200") {
                                $(sendAuthNumBtn).html(`인증번호 확인`) // 문구 변경
                                sendAuthNumBtn.dataset.type = "2" // 같은 버튼 재활용
                                timeout(topParentNode);
                            }
                        }, null)
                }

                // 인증번호 확인
                if (sendAuthNumBtn.dataset.type === "2") {
                    // 인증번호 서버 전송 -> 전송된 인증번호가 맞는지 검증 -> 맞을 시 해당 이메일의 아이디 response
                    // 암호화 정책 여부 정할것 ex) abc***7779 OR abcdef7779
                    param.auth = $(topParentNode).find(".authNum").val()
                    ajaxCall("POST", "/api/view/user/find", param, null,
                        (data) => {
                            if (data.code === "200") {
                                alert(`아이디 : ${data.data}`)
                            }
                            if (data.code === "204") {
                                alert(data.msg)
                            }
                        }, null)
                }
            })


            // 로그인 버튼
            $(".loginBtn").on("click", function (e) {
                $(".loginFrm").submit()
            })
        })

        let time = 180;      // 최초 설정 시간(기본 : 초)
        let min = "";
        let sec = "";

        function timeout(topParentNode) {
            let timeOutMsg = $(topParentNode).find(".timeOut") // 타이머 영역 node
            setInterval(() => {
                min = parseInt(time / 60)
                sec = time % 60;
                $(timeOutMsg).html(`${min}분 ${sec}초`).removeClass("d-none").addClass("d-flex");
                time--;
                if (time < 60) {
                    clearInterval(timeout);
                    $(timeOutMsg).html(`시간초과`);
                }
            }, 1000)

            setTimeout(() => {
                $(topParentNode).find(".inputInfo, .inputAuth").toggleClass("d-none");
            }, 1000)
        }
    </script>
</head>
<!-- TODO style 태그 정리하기 -->
<body>
    <section layout:fragment="content">
        <div class="login d-flex flex-column" style="width: 500px; height: 520px; box-shadow: 0px 10px 34px -15px rgb(0 0 0 / 24%); background: white">
            <div style="width: 100%;display: flex;justify-content: center;">
                <div class="loginTitle" style="width: 120px;height: 120px; background: #8d448d; font-size: 30px;border-radius: 50%;margin-top: 10%; text-align: center">
                    <img src="/static/img/login/loginIcon.png" alt="로그인 유저 아이콘" class="w-100">
                    <span style="color: #8d448d; margin-top: 10px;font-size: 1.75rem">로그인</span>
                </div>
            </div>

            <form class="loginFrm" action="/api/view/user/signIn" method="post" style="margin-top: 15%;width: 100%;height: 130px;">
                <div class="form-floating w-75 m-auto mb-3">
                    <input type="text" class="form-control" id="memberId" name="memberId" style="background: #dcdcdc;">
                    <label for="memberId" style="right: unset">아이디</label>
                </div>
                <div class="form-floating w-75 m-auto">
                    <input type="password" class="form-control" id="pwd" name="pwd" style="background: #dcdcdc;">
                    <label for="pwd" style="right: unset">패스워드</label>
                </div>
            </form>

            <!--아이디 찾기-->
            <div class="findIdDiv w-100 d-none" style="margin-top: 15%;">
                <!--                <div class="w-75 m-auto mb-3">-->
                <!--                    <span>아이디 찾기</span>-->
                <!--                </div>-->
                <div class="w-75 m-auto mb-3">
                    <div class="inputInfo form-floating">
                        <input type="text" class="fEmail form-control" id="fIdEmail" style="background: #dcdcdc;">
                        <label for="fIdEmail" style="right: unset">회원가입 시 입력한 이메일을 입력하세요</label>
                    </div>

                    <div class="inputAuth form-floating d-none">
                        <input type="text" class="authNum form-control" id="authNumId" style="background: #dcdcdc;">
                        <label for="authNumId" style="right: unset">인증번호입력</label>
                    </div>

                    <span class="timeOut d-none justify-content-end mt-1" style="font-size: 0.8rem;"></span>
                    <span class="sendAuthNumberBtn AuthId d-flex justify-content-end mt-1" style="font-size: 0.8rem; cursor: pointer" data-type="0">인증번호 받기</span>
                </div>
            </div>

            <!--비밀번호 찾기-->
            <div class="findPwDiv w-100 d-none" style="margin-top: 15%;">
                <!--                <div class="w-75 m-auto mb-3">-->
                <!--                    <span>비밀번호 찾기</span>-->
                <!--                </div>-->
                <div class="w-75 m-auto mb-3">
                    <div class="inputInfo form-floating mb-3">
                        <input type="text" class="fEmail form-control" id="fPwEmail" style="background: #dcdcdc;">
                        <label for="fPwEmail" style="right: unset">회원가입 시 입력한 이메일을 입력하세요</label>
                    </div>

                    <div class="inputInfo form-floating">
                        <input type="text" class="fId form-control" id="fPwId" style="background: #dcdcdc;">
                        <label for="fPwId" style="right: unset">회원가입 시 입력한 아이디를 입력하세요</label>
                    </div>

                    <div class="inputAuth form-floating d-none">
                        <input type="text" class="authNum form-control" id="authNumPw" style="background: #dcdcdc;">
                        <label for="authNumPw" style="right: unset">인증번호입력</label>
                    </div>

                    <span class="timeOut d-none justify-content-end mt-1" style="font-size: 0.8rem;"></span>
                    <span class="sendAuthNumberBtn AuthPw d-flex justify-content-end mt-1" style="font-size: 0.8rem; cursor: pointer" data-type="1">인증번호 받기</span>
                </div>
            </div>

            <div class="findIdPwDiv mt-4 w-100">
                <div class="w-75 text-start m-auto">
                    <span style="cursor: pointer" class="findIdBtn">아이디 찾기</span>
                </div>
                <div class="w-75 text-start m-auto">
                    <span style="cursor: pointer" class="findPwBtn">비밀번호 찾기</span>
                </div>

            </div>
            <div class="loginBtnDiv mt-2 w-100">
                <div class="w-75 text-center m-auto">
                    <button class="loginBtn" style="width: 100%;margin-top: 10%;height: 50px;background: #8d448b !important;border: 1px solid #8d448b !important;color: #fff !important; border-radius: 0.25rem;">로그인</button>
                </div>
            </div>
        </div>
    </section>
</body>
</html>
