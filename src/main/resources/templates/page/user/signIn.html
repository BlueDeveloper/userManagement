<!DOCTYPE html>
<html lang="ko" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/common/layout/layout.html}">
    <head>
        <link rel="stylesheet" href="/static/css/user/signIn.css">
        <script>
            const gbl = {timer: ""}

            $(function () {
                init()                                                          // 초기화 함수
                $(".loginBtn").on("click", login)                               // 로그인
                $(".findIdBtn, .findPwBtn").on("click", showFindIdPw)           // 아이디/비밀번호 찾기 버튼 클릭
                $(".sendAuthNumberBtn.id").on("click", findId);                 // 아이디 찾기의 인증번호 찾기
                $(".sendAuthNumberBtn.pw").on("click", findPw);                 // 아이디 찾기의 인증번호 찾기
                $(".checkAuthNumberBtn").on("click", beforeCheckAuthNum);       // 인증번호 확인 버튼
                $(".backArrow").on("click", backArrow);                         // 뒤로가기 버튼 클릭
                $("#pwd").on("keydown", enterLogin);                            // 비밀번호 엔터 로그인
            })

            function init(){
                $("#memberId").focus()
            }

            function login() {
                $(".loginFrm").submit()
            }

            function showFindIdPw(e) {
                $(`.loginTitle`).html(e.target.textContent).css("font-size", "1.4rem")
                $(`.loginFrm, .findIdPwDiv, .loginBtnDiv`).addClass("d-none");
                $(`.backArrow, .${e.target.className.substring(0, 6)}Div`).removeClass("d-none") //아이디/비밀번호 찾기 div + 뒤로가기 화살표 활성화
            }

            function findId(e) {
                let obj = {
                    node: {timeOutMsg: $(".timeOut.id")},  // 인증번호 유효시간 표기 텍스트 노드
                    data: {
                        email: $(".fEmail.id").val(),  // 이메일 값
                        authType: "I"                 // 인증타입 구분
                    }
                };
                if (obj.data.email === "" || obj.data.email === undefined || !reg_email.test(obj.data.email)) {
                    alert("이메일 형식을 확인해주세요.");
                    return false;
                }

                sendAuthNum(obj, () => {
                    $(".authBtn.id").toggleClass("d-none")
                    $(".inputInfo.id").toggleClass("d-none")
                });
            }

            function findPw(e) {
                let obj = {
                    node: {
                        timeOutMsg: $(".timeOut.pw")
                    },  // 인증번호 유효시간 표기 텍스트 노드
                    data: {
                        email: $(".fEmail.pw").val(),  // 이메일 값
                        id: $(".fId.pw").val(),        // 아이디 값
                        authType: "P"                 // 인증타입 구분
                    }
                };
                if (obj.data.email === "" || !reg_email.test(obj.data.email)) {
                    alert("이메일 형식을 확인해주세요.");
                    return false;
                }
                if (obj.data.id === "") {
                    alert("아이디를 입력해주세요");
                    return false;
                }
                sendAuthNum(obj, () => {
                    $(".authBtn.pw").toggleClass("d-none")
                    $(".inputInfo.pw").toggleClass("d-none")
                });
            }


            // 인증번호 확인
            function beforeCheckAuthNum(e) {
                const authType = e.target.dataset.authtype;
                if (authType === "I") {
                    checkAuthNum(authType, {email: $(".fEmail.id").val(), auth: $(".authNum.id").val(), authType: authType},
                        (data) => {
                            $(".inputInfo.id").addClass("d-none")
                            $(".success.id, .successId").removeClass("d-none").val(data.data);
                            clearInterval(gbl.timer);
                        })
                } else if (authType === "P") {
                    checkAuthNum(authType, {email: $(".fEmail.pw").val(), id: $(".fId.pw").val(), auth: $(".authNum.pw").val(), authType: authType},
                        (data) => {
                            // 비밀번호 변경 프로세스 추가
                        })
                }
            }

            // 인증번호 유효시간
            function timeout(timeOutMsg, time) {
                let min = "";
                let sec = "";
                gbl.timer = setInterval(() => {
                    min = parseInt(time / 60)
                    sec = time % 60;
                    $(timeOutMsg).html(`${min}분 ${sec}초`).removeClass("d-none").addClass("d-flex");
                    time--;
                    if (time < 0) {
                        clearInterval(gbl.timer);
                        $(timeOutMsg).html(`시간초과`);
                        $(".checkAuthNumberBtn").addClass("d-none");
                    }
                }, 1000)
            }

            function backArrow() {
                $(`.loginTitle`).html(`로그인`).css("font-size", "1.5rem")                      //Title 변경
                $(`.findIdDiv, .findPwDiv, .backArrow`).addClass("d-none")                      //아이디/비밀번호 찾기 div + 뒤로가기 화살표 숨김
                $(`.loginFrm, .findIdPwDiv, .loginBtnDiv`).removeClass("d-none");               //로그인 화면 SHOW
                $(".inputInfo, .sendAuthNumberBtn").removeClass("d-none")                       //아이디/비밀번호에서 보여질 폼
                $(".inputAuth, .checkAuthNumberBtn, .success").addClass("d-none")               //아이디/비밀번호에서 숨겨질 품
                $(".timeOut, .fEmail, .fId, .authNum, .successId").val("").html("");            //인증 유효시간, 이메일, 아이디, 인증번호
                clearInterval(gbl.timer)                                                        //타임아웃 Interval 초기화
            }

            function enterLogin(e) {
                if (e.keyCode === 13) login()
            }
        </script>
    </head>
    <body>
        <div layout:fragment="content" class="signIn container">
            <div class="titleDiv ">
                <div class="backArrowDiv">
                    <img class="backArrow hover d-none" src="/img/login/backArrow.png" alt="뒤로가기 아이콘">
                </div>
                <div class="loginTitleIcon">
                    <img src="/img/common/profileImg.png" alt="로그인 유저 아이콘">
                </div>
                <span class="loginTitle">로그인</span>
            </div>

            <form class="loginFrm box" action="/api/view/user/signIn" method="post">
                <div class="form-floating">
                    <input type="text" class="form-control" id="memberId" name="memberId">
                    <label for="memberId">아이디</label>
                </div>
                <div class="form-floating mt-u5">
                    <input type="password" class="form-control" id="pwd" name="pwd">
                    <label for="pwd">패스워드</label>
                </div>
            </form>

            <div class="findIdDiv box d-none">
                <div class="inputInfo id form-floating">
                    <input type="text" class="fEmail id form-control" id="fIdEmail">
                    <label for="fIdEmail">이메일</label>
                </div>
                <div class="inputInfo id inputAuth d-none form-floating">
                    <input type="text" class="authNum id form-control" id="authNumId">
                    <label for="authNumId">인증번호</label>
                </div>
                <div class="success id d-none form-floating">
                    <input type="text" class="successId id form-control" id="successId">
                    <label for="successId">아이디</label>
                </div>
                <span class="timeOut id"></span>
                <span class="authBtn sendAuthNumberBtn id btn-outline-dark hover">인증번호 받기</span>
                <span class="authBtn checkAuthNumberBtn id btn-outline-dark hover d-none" data-authType="I">인증번호 확인</span>
            </div>

            <div class="findPwDiv box d-none">
                <div class="inputInfo pw form-floating">
                    <input type="text" class="fEmail pw form-control" id="fPwEmail">
                    <label for="fPwEmail">이메일</label>
                </div>

                <div class="inputInfo pw form-floating mt-u5">
                    <input type="text" class="fId pw form-control" id="fPwId">
                    <label for="fPwId">아이디</label>
                </div>

                <div class="inputInfo pw inputAuth d-none form-floating">
                    <input type="text" class="authNum pw form-control" id="authNumPw">
                    <label for="authNumPw">인증번호</label>
                </div>

                <!-- TODO 패스워드찾기 인증 성공 시 신규 패스워드로 변경하는 로직 추가 -->
                <!--<div class="inputInfo pw form-floating">
                    <input type="text" class="fEmail pw form-control" id="fPwEmail" style="background: #dcdcdc;">
                    <label for="fPwEmail" style="right: unset">패스워드</label>
                </div>
                <div class="inputInfo pw form-floating" style="width: 100%;margin-top: 5%">
                    <input type="text" class="fId pw form-control" id="fPwId" style="background: #dcdcdc;">
                    <label for="fPwId" style="right: unset">패스워드</label>
                </div>-->

                <span class="timeOut pw"></span>
                <span class="authBtn sendAuthNumberBtn pw btn-outline-dark hover">인증번호 받기</span>
                <span class="authBtn checkAuthNumberBtn pw btn-outline-dark hover d-none" data-authType="P">인증번호 확인</span>
            </div>


            <div class="findIdPwDiv box">
                <span class="findIdBtn hover">아이디 찾기</span>
                <span class="findPwBtn hover">비밀번호 찾기</span>
            </div>

            <div class="loginBtnDiv box">
                <button class="loginBtn btn-outline-dark">로그인</button>
            </div>
        </div>
    </body>
</html>
